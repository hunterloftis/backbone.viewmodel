(function(a){a.ViewModel=a.Model.extend({initialize:function(){this._bindings=[];this._computes={}},bindView:function(b,a){var c=$(a||"body").find("*["+b+"]");_.each(c,this.bindToNode(b))},unbindView:function(){_.each(this._bindings,function(b){b.stop()});this._bindings=[]},isBoundTo:function(b){return _.any(this._bindings,function(a){return a.node===b})},bindToNode:function(b){var a=this;return function(c){if(!a.isBoundTo(c)){var e=$(c).attr(b).split(","),c=_.map(e,a.parseBinding(c));_.each(c,a.createBinding,
a)}}},parseBinding:function(b){var a=this;return function(c){var e=c.split(":"),c=e[0].trim(),e=e[1].trim();return{type:c,node:b,viewModel:a,attribute:e}}},createBinding:function(b){var d=a.Binding[b.type];if(d){if(d=new d(b))return d.start(),this._bindings.push(d),d;throw Error("Unable to create '"+b.type+"' binding");}throw Error("Trying to create a binding of unknown type '"+b.type+"'");},get:function(b){a.Computed.track(this,"change:"+b);return this.attributes[b]},compute:function(b,d){var c=
new a.Computed(b,d,this);this._computes[b]=c;c.on("change",this.onCompute,this);c.run()},onCompute:function(b){this.set(b.attr,b.result)}})})(Backbone);
(function(a){a.Binding=function(b){_.bindAll(this);_.extend(this,b);this.initialize.apply(this,arguments)};_.extend(a.Binding.prototype,{initialize:function(){},start:function(){this.viewModel.on("change:"+this.attribute,this.onModelChange);this.onModelChange()},onModelChange:function(){},onViewChange:function(){},stop:function(){this.viewModel.off("change:"+this.attribute,this.onModelChange)}});a.Binding.extend=a.Model.extend})(Backbone);
(function(a){a.Model.prototype.get=function(b){a.Computed.track(this,"change:"+b);return this.attributes[b]};_.each("get getByCid where pluck clone at toJSON".split(" "),function(b){a.Collection.prototype["_"+b]=a.Collection.prototype[b];a.Collection.prototype[b]=function(){a.Computed.track(this,"add remove reset change create sort");return this["_"+b].apply(this,arguments)}});a.Computed=function(b,a,c){this.attr=b;"function"===typeof a?(this.get=a,this.safe=!1):(_.extend(this,a),this.safe=a.hasOwnProperty("fail"));
this.context=c;this.dependencies=[];this.result=void 0};_.extend(a.Computed.prototype,a.Events,{run:function(){a.Computed.startTracking();if(this.safe)try{this.result=this.get.call(this.context)}catch(b){this.result=this.fail}else this.result=this.get.call(this.context);this.update(a.Computed.stopTracking());this.trigger("change",this);return this.result},onChange:function(){this.run()},update:function(a){_.each(this.dependencies,this.remove,this);_.each(a,this.add,this);this.dependencies=a},remove:function(a){a.model.off(a.event,
this.onChange,this)},add:function(a){a.model.on(a.event,this.onChange,this)}});_.extend(a.Computed,{_computations:[],_dependencies:void 0,startTracking:function(){a.Computed._dependencies=[];a.Computed._computations.push(a.Computed._dependencies)},stopTracking:function(){var b=a.Computed._computations.pop();a.Computed._dependencies=a.Computed._computations.length?a.Computed._computations(a.Computed._computations.length-1):void 0;return b},track:function(b,d){a.Computed._dependencies&&a.Computed._dependencies.push({model:b,
event:d})}})})(Backbone);
(function(a){a.Binding.visible=a.Binding.extend({onModelChange:function(){return this.viewModel.get(this.attribute)?$(this.node).show():$(this.node).hide()}});a.Binding.text=a.Binding.extend({onModelChange:function(){var a=this.viewModel.get(this.attribute);$(this.node).text(a)}});a.Binding.val=a.Binding.extend({start:function(){a.Binding.prototype.start.apply(this,arguments);$(this.node).on("keyup change",this.onViewChange)},onModelChange:function(){var a=this.viewModel.get(this.attribute);$(this.node).val(a)},
onViewChange:function(){this.viewModel.set(this.attribute,$(this.node).val())},stop:function(){a.Binding.prototype.stop.apply(this,arguments);$(this.node).off("keyup change",this.onViewChange)}})})(Backbone);
